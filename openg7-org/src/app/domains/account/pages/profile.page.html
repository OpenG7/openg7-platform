<section class="mx-auto flex w-full max-w-4xl flex-col gap-6 p-6" data-og7="user-profile">
  <header class="flex flex-col gap-2" data-og7="user-profile-header">
    <h1 class="text-3xl font-semibold text-slate-900">
      {{ 'auth.profile.title' | translate }}
    </h1>
    <p class="text-sm text-slate-600">
      {{ 'auth.profile.subtitle' | translate }}
    </p>
    @if (profile(); as current) {
      <p class="text-sm text-slate-500" data-og7="user-profile-email">
        {{ current.email }}
      </p>
    }
  </header>

  @if (loading()) {
    <p class="text-sm text-slate-500">
      {{ 'auth.profile.loading' | translate }}
    </p>
  } @else {
    <form
      class="flex flex-col gap-8"
      [formGroup]="form"
      (ngSubmit)="onSubmit()"
      novalidate
      data-og7="user-profile-form"
    >
      <section class="flex flex-col gap-4" data-og7="user-profile-avatar">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center">
          <div class="flex h-20 w-20 items-center justify-center overflow-hidden rounded-full bg-slate-200">
            @if (avatarPreview(); as avatarUrl) {
              <img
                [src]="avatarUrl"
                [alt]="'auth.profile.avatar.alt' | translate"
                class="h-full w-full object-cover"
                (error)="onAvatarPreviewError()"
              />
            } @else {
              @if (profile(); as current) {
                <span class="text-lg font-semibold uppercase text-slate-500">
                  {{ buildInitials(current) }}
                </span>
              }
            }
          </div>
          <div class="flex-1">
            <label class="block text-sm font-medium text-slate-700" for="profile-avatar-url">
              {{ 'auth.profile.avatar.label' | translate }}
            </label>
            <input
              id="profile-avatar-url"
              type="url"
              class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm"
              formControlName="avatarUrl"
              placeholder="{{ 'auth.profile.avatar.placeholder' | translate }}"
              autocomplete="url"
            />
            @if (form.controls.avatarUrl.touched && form.controls.avatarUrl.invalid) {
              <p class="mt-1 text-xs text-error" data-og7="user-profile-avatar-error">
                {{ 'validation.url' | translate }}
              </p>
            }
          </div>
        </div>
      </section>

      <section class="flex flex-col gap-4" data-og7="user-profile-contact">
        <h2 class="text-lg font-semibold text-slate-900">
          {{ 'auth.profile.contact.title' | translate }}
        </h2>
        <div class="grid gap-4 sm:grid-cols-2">
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-700" for="profile-first-name">
              {{ 'auth.profile.contact.firstName' | translate }}
            </label>
            <input
              id="profile-first-name"
              type="text"
              class="rounded border border-slate-300 px-3 py-2 text-sm"
              formControlName="firstName"
              autocomplete="given-name"
            />
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-700" for="profile-last-name">
              {{ 'auth.profile.contact.lastName' | translate }}
            </label>
            <input
              id="profile-last-name"
              type="text"
              class="rounded border border-slate-300 px-3 py-2 text-sm"
              formControlName="lastName"
              autocomplete="family-name"
            />
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-700" for="profile-job-title">
              {{ 'auth.profile.contact.jobTitle' | translate }}
            </label>
            <input
              id="profile-job-title"
              type="text"
              class="rounded border border-slate-300 px-3 py-2 text-sm"
              formControlName="jobTitle"
              autocomplete="organization-title"
            />
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-700" for="profile-organization">
              {{ 'auth.profile.contact.organization' | translate }}
            </label>
            <input
              id="profile-organization"
              type="text"
              class="rounded border border-slate-300 px-3 py-2 text-sm"
              formControlName="organization"
              autocomplete="organization"
            />
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-700" for="profile-phone">
              {{ 'auth.profile.contact.phone' | translate }}
            </label>
            <input
              id="profile-phone"
              type="tel"
              class="rounded border border-slate-300 px-3 py-2 text-sm"
              formControlName="phone"
              autocomplete="tel"
            />
            @if (form.controls.phone.touched && form.controls.phone.invalid) {
              <p class="text-xs text-error" data-og7="user-profile-phone-error">
                {{ 'validation.caPhone' | translate }}
              </p>
            }
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-700" for="profile-email">
              {{ 'auth.profile.contact.email' | translate }}
            </label>
            <input
              id="profile-email"
              type="email"
              class="rounded border border-slate-300 bg-slate-100 px-3 py-2 text-sm"
              formControlName="email"
              readonly
            />
          </div>
        </div>
      </section>

      <section class="flex flex-col gap-4" data-og7="user-profile-preferences">
        <h2 class="text-lg font-semibold text-slate-900">
          {{ 'auth.profile.preferences.title' | translate }}
        </h2>
        <div class="grid gap-4 sm:grid-cols-2">
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-700" for="profile-sectors">
              {{ 'auth.profile.preferences.sectors' | translate }}
            </label>
            <input
              id="profile-sectors"
              type="text"
              class="rounded border border-slate-300 px-3 py-2 text-sm"
              formControlName="sectorPreferences"
              placeholder="energy, manufacturing"
            />
            @if (form.controls.sectorPreferences.touched && form.controls.sectorPreferences.invalid) {
              <p class="text-xs text-error" data-og7="user-profile-sector-preferences-error">
                {{ 'auth.profile.validation.list' | translate }}
              </p>
            }
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-700" for="profile-provinces">
              {{ 'auth.profile.preferences.provinces' | translate }}
            </label>
            <input
              id="profile-provinces"
              type="text"
              class="rounded border border-slate-300 px-3 py-2 text-sm"
              formControlName="provincePreferences"
              placeholder="qc, on"
            />
            @if (form.controls.provincePreferences.touched && form.controls.provincePreferences.invalid) {
              <p class="text-xs text-error" data-og7="user-profile-province-preferences-error">
                {{ 'auth.profile.validation.list' | translate }}
              </p>
            }
          </div>
        </div>
        <div
          class="flex flex-col gap-3 rounded-lg border border-slate-200 bg-slate-50 p-4"
          data-og7="user-profile-notifications"
        >
          <label class="flex items-start gap-3" for="profile-email-notifications">
            <input
              id="profile-email-notifications"
              type="checkbox"
              class="mt-1 h-4 w-4 rounded border-slate-400"
              formControlName="emailNotifications"
            />
            <span class="space-y-1">
              <span class="block text-sm font-semibold text-slate-900">
                {{ 'auth.profile.preferences.email.title' | translate }}
              </span>
              <span class="block text-sm text-slate-600">
                {{ 'auth.profile.preferences.email.description' | translate }}
              </span>
            </span>
          </label>
          <div class="flex flex-col gap-1">
            <label
              class="text-xs font-medium uppercase tracking-wide text-slate-500"
              for="profile-notification-webhook"
            >
              {{ 'auth.profile.preferences.email.webhookLabel' | translate }}
            </label>
            <input
              id="profile-notification-webhook"
              type="url"
              class="rounded border border-slate-300 px-3 py-2 text-sm"
              formControlName="notificationWebhook"
              placeholder="https://cms.example.com/api/notifications/email"
              autocomplete="url"
            />
            @if (form.controls.notificationWebhook.touched && form.controls.notificationWebhook.invalid) {
              <p class="text-xs text-error" data-og7="user-profile-notification-webhook-error">
                @if (form.controls.notificationWebhook.hasError('invalidHttpsUrl')) {
                  {{ 'auth.profile.validation.httpsUrl' | translate }}
                } @else {
                  {{ 'validation.url' | translate }}
                }
              </p>
            }
            <p class="text-xs text-slate-500">
              {{ 'auth.profile.preferences.email.webhookHelp' | translate }}
            </p>
          </div>
        </div>
      </section>

      <div class="flex flex-col items-end gap-3">
        @if (hasUnsavedChanges()) {
          <p class="text-xs text-amber-700" data-og7="user-profile-unsaved-changes">
            {{ 'auth.profile.unsavedChanges' | translate }}
          </p>
        }
        <div class="flex justify-end gap-3">
          <button
            type="button"
            class="inline-flex items-center rounded border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 disabled:opacity-50"
            (click)="resetPendingChanges()"
            [disabled]="saving()"
          >
            {{ 'auth.profile.discard' | translate }}
          </button>
          <button
            type="submit"
            class="inline-flex items-center rounded bg-slate-900 px-4 py-2 text-sm font-semibold text-white disabled:opacity-50"
            [disabled]="!canSave()"
          >
            @if (saving()) {
              {{ 'auth.profile.saving' | translate }}
            } @else {
              {{ 'auth.profile.save' | translate }}
            }
          </button>
        </div>
      </div>
    </form>

    <section
      class="mt-2 flex flex-col gap-5 rounded-xl border border-slate-200 bg-white p-5"
      data-og7="user-profile-security"
    >
      <div class="flex flex-col gap-3" data-og7="user-profile-status">
        <h2 class="text-lg font-semibold text-slate-900">
          {{ 'auth.profile.security.title' | translate }}
        </h2>
        <p class="text-sm text-slate-600">
          {{ 'auth.profile.security.subtitle' | translate }}
        </p>
        <div class="inline-flex w-fit items-center rounded-full border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-700">
          {{ accountStatusKey() | translate }}
        </div>

        @if (accountStatus() === 'emailNotConfirmed') {
          <p class="text-sm text-amber-700">
            {{ 'auth.errors.emailNotConfirmed' | translate }}
          </p>
          <div>
            <button
              type="button"
              class="inline-flex items-center rounded border border-amber-400 px-3 py-2 text-sm font-semibold text-amber-800 disabled:opacity-50"
              data-og7="user-profile-resend-activation"
              (click)="onSendActivationEmail()"
              [disabled]="!canResendActivation()"
            >
              @if (sendingActivationEmail()) {
                {{ 'auth.login.activationEmailSending' | translate }}
              } @else {
                {{ 'auth.profile.security.activation.cta' | translate }}
              }
            </button>
          </div>
        }

        @if (accountStatus() === 'disabled') {
          <p class="text-sm text-error">
            {{ 'auth.errors.accountDisabled' | translate }}
          </p>
        }
      </div>

      <form
        class="grid gap-3 rounded-lg border border-slate-200 p-4 sm:grid-cols-2"
        [formGroup]="passwordForm"
        (ngSubmit)="onChangePassword()"
        novalidate
        data-og7="user-profile-change-password"
      >
        <div class="sm:col-span-2">
          <h3 class="text-sm font-semibold text-slate-900">
            {{ 'auth.profile.security.password.title' | translate }}
          </h3>
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-700" for="profile-password-current">
            {{ 'auth.profile.security.password.current' | translate }}
          </label>
          <input
            id="profile-password-current"
            type="password"
            class="rounded border border-slate-300 px-3 py-2 text-sm"
            formControlName="currentPassword"
            autocomplete="current-password"
          />
          @if (
            passwordForm.controls.currentPassword.touched &&
            passwordForm.controls.currentPassword.hasError('required')
          ) {
            <p class="text-xs text-error">
              {{ 'auth.errors.passwordRequired' | translate }}
            </p>
          }
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-700" for="profile-password-new">
            {{ 'auth.profile.security.password.next' | translate }}
          </label>
          <input
            id="profile-password-new"
            type="password"
            class="rounded border border-slate-300 px-3 py-2 text-sm"
            formControlName="password"
            autocomplete="new-password"
          />
          @if (passwordForm.controls.password.touched && passwordForm.controls.password.invalid) {
            <p class="text-xs text-error">
              @if (passwordForm.controls.password.hasError('required')) {
                {{ 'auth.errors.passwordRequired' | translate }}
              } @else if (passwordForm.controls.password.hasError('minlength')) {
                {{ 'auth.errors.passwordMinLength' | translate }}
              } @else if (passwordForm.controls.password.hasError('weakPassword')) {
                {{ 'auth.profile.security.password.weak' | translate }}
              } @else if (passwordForm.controls.password.hasError('sameAsCurrent')) {
                {{ 'auth.profile.security.password.sameAsCurrent' | translate }}
              }
            </p>
          }
        </div>

        <div class="flex flex-col gap-1 sm:col-span-2">
          <label class="text-sm font-medium text-slate-700" for="profile-password-confirmation">
            {{ 'auth.profile.security.password.confirm' | translate }}
          </label>
          <input
            id="profile-password-confirmation"
            type="password"
            class="rounded border border-slate-300 px-3 py-2 text-sm"
            formControlName="passwordConfirmation"
            autocomplete="new-password"
          />
          @if (
            passwordForm.controls.passwordConfirmation.touched &&
            passwordForm.controls.passwordConfirmation.hasError('required')
          ) {
            <p class="text-xs text-error">
              {{ 'auth.errors.confirmPasswordRequired' | translate }}
            </p>
          }
          @if (
            passwordForm.touched &&
            passwordForm.hasError('passwordMismatch') &&
            !passwordForm.controls.passwordConfirmation.hasError('required')
          ) {
            <p class="text-xs text-error">
              {{ 'auth.errors.passwordMismatch' | translate }}
            </p>
          }
        </div>

        <div class="sm:col-span-2 flex justify-end">
          <button
            type="submit"
            class="inline-flex items-center rounded bg-slate-900 px-4 py-2 text-sm font-semibold text-white disabled:opacity-50"
            [disabled]="!canChangePassword()"
          >
            @if (changingPassword()) {
              {{ 'auth.profile.security.password.loading' | translate }}
            } @else {
              {{ 'auth.profile.security.password.submit' | translate }}
            }
          </button>
        </div>
      </form>

      <form
        class="grid gap-3 rounded-lg border border-slate-200 p-4 sm:grid-cols-2"
        [formGroup]="emailChangeForm"
        (ngSubmit)="onRequestEmailChange()"
        novalidate
        data-og7="user-profile-change-email"
      >
        <div class="sm:col-span-2">
          <h3 class="text-sm font-semibold text-slate-900">
            {{ 'auth.profile.security.emailChange.title' | translate }}
          </h3>
          <p class="text-xs text-slate-600">
            {{ 'auth.profile.security.emailChange.help' | translate }}
          </p>
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-700" for="profile-email-change-new">
            {{ 'auth.profile.security.emailChange.nextEmail' | translate }}
          </label>
          <input
            id="profile-email-change-new"
            type="email"
            class="rounded border border-slate-300 px-3 py-2 text-sm"
            formControlName="email"
            autocomplete="email"
          />
          @if (emailChangeForm.controls.email.touched && emailChangeForm.controls.email.invalid) {
            <p class="text-xs text-error">
              @if (emailChangeForm.controls.email.hasError('required')) {
                {{ 'auth.errors.emailRequired' | translate }}
              } @else if (emailChangeForm.controls.email.hasError('email')) {
                {{ 'auth.errors.emailInvalid' | translate }}
              } @else if (emailChangeForm.controls.email.hasError('sameAsCurrent')) {
                {{ 'auth.profile.security.emailChange.sameAsCurrent' | translate }}
              }
            </p>
          }
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-700" for="profile-email-change-password">
            {{ 'auth.profile.security.emailChange.currentPassword' | translate }}
          </label>
          <input
            id="profile-email-change-password"
            type="password"
            class="rounded border border-slate-300 px-3 py-2 text-sm"
            formControlName="currentPassword"
            autocomplete="current-password"
          />
          @if (
            emailChangeForm.controls.currentPassword.touched &&
            emailChangeForm.controls.currentPassword.hasError('required')
          ) {
            <p class="text-xs text-error">
              {{ 'auth.errors.passwordRequired' | translate }}
            </p>
          }
        </div>

        <div class="sm:col-span-2 flex justify-end">
          <button
            type="submit"
            class="inline-flex items-center rounded bg-slate-900 px-4 py-2 text-sm font-semibold text-white disabled:opacity-50"
            [disabled]="!canRequestEmailChange()"
          >
            @if (requestingEmailChange()) {
              {{ 'auth.profile.security.emailChange.loading' | translate }}
            } @else {
              {{ 'auth.profile.security.emailChange.submit' | translate }}
            }
          </button>
        </div>
      </form>
    </section>
  }
</section>

