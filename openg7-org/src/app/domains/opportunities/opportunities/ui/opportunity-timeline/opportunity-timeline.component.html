<article
  class="opportunity-timeline"
  [attr.aria-labelledby]="'opportunity-title-' + vm().id"
  [attr.data-score-tone]="scoreTone()"
>
  <header class="opportunity-timeline__header">
    <div class="opportunity-timeline__headline">
      <p class="opportunity-timeline__eyebrow">{{ 'opportunities.timeline.prototypeLabel' | translate }}</p>
      <h3 class="opportunity-timeline__title" [id]="'opportunity-title-' + vm().id">{{ vm().title }}</h3>
    </div>
    <div class="opportunity-timeline__score" role="img" [attr.aria-label]="'opportunities.timeline.scoreLabel' | translate:{ value: scoreLabel() }">
      <svg viewBox="0 0 72 72" class="opportunity-timeline__score-figure" aria-hidden="true">
        <defs>
          <linearGradient id="opportunity-score-high" x1="0%" y1="100%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#34d399" />
            <stop offset="100%" stop-color="#22d3ee" />
          </linearGradient>
          <linearGradient id="opportunity-score-medium" x1="0%" y1="100%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#fbbf24" />
            <stop offset="100%" stop-color="#38bdf8" />
          </linearGradient>
          <linearGradient id="opportunity-score-low" x1="0%" y1="100%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#f97316" />
            <stop offset="100%" stop-color="#facc15" />
          </linearGradient>
        </defs>
        <circle class="opportunity-timeline__score-track" cx="36" cy="36" r="28" />
        <circle
          class="opportunity-timeline__score-ring"
          cx="36"
          cy="36"
          r="28"
          [attr.stroke-dasharray]="175.93"
          [attr.stroke-dashoffset]="scoreStrokeDashoffset()"
          [attr.stroke]="scoreStroke()"
        />
      </svg>
      <span class="opportunity-timeline__score-value">{{ scoreLabel() }}</span>
    </div>
  </header>

  <section class="opportunity-timeline__actors">
    <div class="opportunity-timeline__actor">
      <p class="opportunity-timeline__actor-label">{{ 'opportunities.timeline.buyer' | translate }}</p>
      <div class="opportunity-timeline__actor-content">
        @if (vm().buyer.logoUrl) {
          <img
            class="opportunity-timeline__actor-logo"
            [src]="vm().buyer.logoUrl!"
            [alt]="vm().buyer.name"
            loading="lazy"
            decoding="async"
          />
        }
        <div class="opportunity-timeline__actor-body">
          <p class="opportunity-timeline__actor-name">{{ vm().buyer.name }}</p>
          <div class="opportunity-timeline__chips" role="list">
            <span class="opportunity-timeline__chip" role="listitem">{{ vm().buyer.province }}</span>
            <span class="opportunity-timeline__chip" role="listitem">{{ vm().buyer.sector }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="opportunity-timeline__actor opportunity-timeline__actor--supplier">
      <p class="opportunity-timeline__actor-label">{{ 'opportunities.timeline.supplier' | translate }}</p>
      <div class="opportunity-timeline__actor-content">
        <div class="opportunity-timeline__actor-body">
          <p class="opportunity-timeline__actor-name">{{ vm().supplier.name }}</p>
          <div class="opportunity-timeline__chips" role="list">
            <span class="opportunity-timeline__chip" role="listitem">{{ vm().supplier.province }}</span>
            <span class="opportunity-timeline__chip" role="listitem">{{ vm().supplier.sector }}</span>
          </div>
        </div>
        @if (vm().supplier.logoUrl) {
          <img
            class="opportunity-timeline__actor-logo"
            [src]="vm().supplier.logoUrl!"
            [alt]="vm().supplier.name"
            loading="lazy"
            decoding="async"
          />
        }
      </div>
    </div>
  </section>

  <section class="opportunity-timeline__context" [id]="'opportunity-context-' + vm().id">
    <div class="opportunity-timeline__context-item">
      <span class="opportunity-timeline__context-label">{{ 'opportunities.timeline.distance' | translate }}</span>
      <span class="opportunity-timeline__context-value">{{ distanceLabel() }}</span>
    </div>
    @if (vm().context.leadTime) {
      <div class="opportunity-timeline__context-item">
        <span class="opportunity-timeline__context-label">{{ 'opportunities.timeline.leadTime' | translate }}</span>
        <span class="opportunity-timeline__context-value">{{ vm().context.leadTime }}</span>
      </div>
    }
    @if (co2Label(); as co2) {
      <div class="opportunity-timeline__context-item">
        <span class="opportunity-timeline__context-label">{{ 'opportunities.timeline.co2Savings' | translate }}</span>
        <span class="opportunity-timeline__context-value">{{ co2 }}</span>
      </div>
    }
    @if (vm().context.logisticsCost) {
      <div class="opportunity-timeline__context-item">
        <span class="opportunity-timeline__context-label">{{ 'opportunities.timeline.logisticsCost' | translate }}</span>
        <span class="opportunity-timeline__context-value">{{ vm().context.logisticsCost }}</span>
      </div>
    }
  </section>

  <section class="opportunity-timeline__steps" [attr.aria-label]="'opportunities.timeline.stepsTitle' | translate">
    <ol class="opportunity-timeline__list">
      @for (step of vm().steps; track step.id; let index = $index) {
        <li class="opportunity-timeline__step" [attr.data-step-index]="index">
          <div class="opportunity-timeline__step-chip">
            <span class="opportunity-timeline__step-index">{{ index + 1 }}</span>
            <span class="opportunity-timeline__step-label">{{ step.title }}</span>
          </div>
          @if (step.summary) {
            <p class="opportunity-timeline__step-summary">{{ step.summary }}</p>
          }
          <dl class="opportunity-timeline__kpis">
            @for (kpi of step.kpis; track kpi.label) {
              <div class="opportunity-timeline__kpi">
                <dt class="opportunity-timeline__kpi-label">{{ kpi.label }}</dt>
                <dd class="opportunity-timeline__kpi-value">
                  {{ kpi.value }}
                  @if (kpi.hint) {
                    <span class="opportunity-timeline__kpi-hint">{{ kpi.hint }}</span>
                  }
                </dd>
              </div>
            }
          </dl>
        </li>
      }
    </ol>
  </section>

  <footer class="opportunity-timeline__actions">
    <button
      type="button"
      class="opportunity-timeline__action-primary"
      (click)="emitViewSheet()"
    >
      {{ 'opportunities.timeline.viewSheet' | translate }}
    </button>
    <button type="button" class="opportunity-timeline__action-secondary" (click)="emitConnect()">
      {{ 'opportunities.timeline.connect' | translate }}
    </button>
    <button type="button" class="opportunity-timeline__action-ghost">{{ 'opportunities.timeline.save' | translate }}</button>
  </footer>
</article>
