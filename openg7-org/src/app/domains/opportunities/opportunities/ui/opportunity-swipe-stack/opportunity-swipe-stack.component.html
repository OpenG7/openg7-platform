<section class="swipe-stack" aria-live="polite">
  <header class="swipe-stack__header">
    <div class="swipe-stack__headline">
      <h3 class="swipe-stack__title">{{ vm().title }}</h3>
      <p class="swipe-stack__subtitle" *ngIf="vm().subtitle">{{ vm().subtitle }}</p>
    </div>
    <div class="swipe-stack__meta" aria-hidden="true">
      <span class="swipe-stack__counter">{{ total() === 0 ? 0 : activeIndex() + 1 }}/{{ total() }}</span>
      <div class="swipe-stack__progress">
        <div class="swipe-stack__progress-bar" [style.width.%]="progressPercent()"></div>
      </div>
    </div>
  </header>

  <ol class="swipe-stack__breadcrumb" role="list">
    <li
      *ngFor="let crumb of breadcrumb()"
      class="swipe-stack__crumb"
      [class.swipe-stack__crumb--active]="crumb.active"
      [class.swipe-stack__crumb--passed]="crumb.passed"
    >
      <span class="visually-hidden">{{ crumb.label }}</span>
    </li>
  </ol>

  <div class="swipe-stack__cards" [attr.data-empty]="total() === 0">
    <article
      *ngFor="let card of vm().cards; let index = index"
      class="swipe-card"
      [style.zIndex]="vm().cards.length - index"
      [style.transform]="cardTransform(index)"
      [style.opacity]="cardOpacity(index)"
      [attr.aria-hidden]="index === activeIndex() ? null : 'true'"
      [attr.data-state]="index === activeIndex() ? 'active' : index < activeIndex() ? 'dismissed' : 'queued'"
    >
      <header class="swipe-card__header">
        <span class="swipe-card__score">{{ card.score }}%</span>
        <p class="swipe-card__commodity">{{ card.title }}</p>
      </header>
      <dl class="swipe-card__actors">
        <div class="swipe-card__actor">
          <dt class="swipe-card__actor-label">Acheteur</dt>
          <dd class="swipe-card__actor-name">{{ card.buyer.name }}</dd>
          <dd class="swipe-card__actor-meta">{{ card.buyer.provinceLabelKey }}</dd>
          <dd class="swipe-card__actor-meta">{{ card.buyer.sectorLabelKey }}</dd>
        </div>
        <div class="swipe-card__actor">
          <dt class="swipe-card__actor-label">Fournisseur</dt>
          <dd class="swipe-card__actor-name">{{ card.supplier.name }}</dd>
          <dd class="swipe-card__actor-meta">{{ card.supplier.provinceLabelKey }}</dd>
          <dd class="swipe-card__actor-meta">{{ card.supplier.sectorLabelKey }}</dd>
        </div>
      </dl>
      <footer class="swipe-card__footer">
        <span class="swipe-card__distance" *ngIf="card.distanceLabel as distance">{{ distance }}</span>
        <span class="swipe-card__distance" *ngIf="!card.distanceLabel">Distance en modélisation</span>
      </footer>
    </article>

    <p class="swipe-stack__empty" *ngIf="total() === 0">
      Aucune opportunité dans la pile pour le moment — ajustez vos filtres pour relancer la sélection.
    </p>
  </div>

  <footer class="swipe-stack__actions" *ngIf="activeCard() as card">
    <button type="button" class="swipe-stack__action swipe-stack__action--back" (click)="onBack()">
      ⟲ Revenir
    </button>
    <div class="swipe-stack__action-group">
      <button type="button" class="swipe-stack__action swipe-stack__action--dismiss" (click)="swipe('dismissed')">
        ⬅️ Ignorer
      </button>
      <button type="button" class="swipe-stack__action swipe-stack__action--open" (click)="swipe('open')">
        ⬆️ Ouvrir
      </button>
      <button type="button" class="swipe-stack__action swipe-stack__action--interested" (click)="swipe('interested')">
        ➡️ Intéressé
      </button>
    </div>
  </footer>

  <p class="swipe-stack__feedback" *ngIf="lastAction() as action">
    <span class="swipe-stack__feedback-label">Dernière action :</span>
    <span class="swipe-stack__feedback-value">
      <ng-container [ngSwitch]="action.direction">
        <span *ngSwitchCase="'interested'">Match {{ action.cardId }} marqué comme intéressé.</span>
        <span *ngSwitchCase="'dismissed'">Match {{ action.cardId }} mis de côté.</span>
        <span *ngSwitchCase="'open'">Fiche {{ action.cardId }} ouverte.</span>
      </ng-container>
    </span>
  </p>
</section>
